name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npm run build
      - name: Fix asset directory name and ensure .nojekyll exists
        run: |
          # Check if 'astro' folder exists (without underscore) and rename to '_astro'
          if [ -d "./dist/astro" ] && [ ! -d "./dist/_astro" ]; then
            echo "⚠️  Found 'astro' folder without underscore - renaming to '_astro'"
            mv ./dist/astro ./dist/_astro
          fi
          
          # Create .nojekyll file (empty - GitHub Pages requires this to disable Jekyll)
          touch ./dist/.nojekyll
          chmod 644 ./dist/.nojekyll
          
          # Alternative method: Create _config.yml to disable Jekyll (backup)
          echo "theme: null" > ./dist/_config.yml
          echo "plugins: []" >> ./dist/_config.yml
          
          echo "✅ Verifying .nojekyll file exists:"
          ls -la ./dist/.nojekyll || exit 1
          echo "File size: $(wc -c < ./dist/.nojekyll) bytes"
          echo ""
          echo "✅ Checking for asset directories:"
          ls -la ./dist/ | grep -E "(astro|_astro)" || echo "No astro directory found"
          echo ""
          echo "✅ Verifying _astro directory exists:"
          if [ -d "./dist/_astro" ]; then
            ls -la ./dist/_astro/
            echo ""
            echo "✅ Verifying CSS files in _astro:"
            ls -la ./dist/_astro/*.css 2>/dev/null | head -5 || echo "⚠️  Warning: No CSS files found"
          else
            echo "❌ ERROR: _astro directory does not exist!"
            exit 1
          fi
          echo ""
          echo "✅ Checking HTML files for CSS references:"
          grep -r "href.*_astro" ./dist/*.html || echo "No _astro references found in HTML"
          echo ""
          echo "✅ Verifying all files in dist root:"
          ls -la ./dist/ | head -20
          echo ""
          echo "✅ Full directory tree (first 30 lines):"
          find ./dist -type f | head -30
          echo ""
          echo "✅ Creating verification report:"
          echo "Files in dist root:" > ./dist/BUILD_INFO.txt
          ls -la ./dist/ >> ./dist/BUILD_INFO.txt
          echo "" >> ./dist/BUILD_INFO.txt
          echo ".nojekyll exists: $([ -f ./dist/.nojekyll ] && echo 'YES' || echo 'NO')" >> ./dist/BUILD_INFO.txt
          echo "_astro directory exists: $([ -d ./dist/_astro ] && echo 'YES' || echo 'NO')" >> ./dist/BUILD_INFO.txt
          echo "CSS files count: $(find ./dist/_astro -name '*.css' 2>/dev/null | wc -l)" >> ./dist/BUILD_INFO.txt
          cat ./dist/BUILD_INFO.txt
      - uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/deploy-pages@v4

